# Photop E2Eテスト仕様書

テストフレームワーク: **Playwright**
対象ブラウザ: Chromium（モバイルビューポート: 375×812）

---

## 前提条件

- Supabase ローカル環境 (`supabase start`) が起動済み
- Next.js 開発サーバー (`npm run dev`) が起動済み
- テスト用メールアドレスは `{テスト名}@test.local` 形式
- 各テストシナリオは独立（テスト間でデータ共有しない）

---

## 1. 認証フロー

### 1.1 サインアップ

| # | テストケース | 操作手順 | 期待結果 |
|---|------------|---------|---------|
| 1 | 正常系: サインアップ成功 | `/` → サインアップ切替 → メール・パスワード・表示名入力 → 送信 | ペアリング画面 (`/pairing`) にリダイレクト |
| 2 | 正常系: プロフィール自動作成 | サインアップ後にプロフィール画面へ | 入力した表示名が表示される |
| 3 | 異常系: メール形式不正 | 不正メール入力 → 送信 | バリデーションエラー表示、画面遷移なし |
| 4 | 異常系: パスワード短すぎ | 5文字パスワード → 送信 | バリデーションエラー表示 |
| 5 | 異常系: 重複メール | 既存メール入力 → 送信 | エラーメッセージ「既に登録済み」 |
| 6 | 異常系: 表示名未入力 | 表示名空で送信 | バリデーションエラー表示 |

### 1.2 ログイン

| # | テストケース | 操作手順 | 期待結果 |
|---|------------|---------|---------|
| 1 | 正常系: ログイン成功（ペアなし） | `/` → メール・パスワード入力 → ログイン | `/pairing` にリダイレクト |
| 2 | 正常系: ログイン成功（ペアあり） | `/` → メール・パスワード入力 → ログイン | `/feed` にリダイレクト |
| 3 | 異常系: パスワード不正 | 間違ったパスワード → ログイン | エラーメッセージ表示 |
| 4 | 異常系: 未登録メール | 未登録メール → ログイン | エラーメッセージ表示 |

### 1.3 ログアウト

| # | テストケース | 操作手順 | 期待結果 |
|---|------------|---------|---------|
| 1 | 正常系: ログアウト | 設定画面 → 「ログアウト」ボタン | `/` にリダイレクト |
| 2 | ログアウト後にフィードアクセス | ログアウト → `/feed` に直接アクセス | `/` にリダイレクト（認証ガード） |

---

## 2. ペアリングフロー

### 2.1 招待コード生成

| # | テストケース | 操作手順 | 期待結果 |
|---|------------|---------|---------|
| 1 | 正常系: コード生成 | `/pairing` → 「コードを生成する」ボタン | 6桁英数字コードが大きく表示される |
| 2 | 正常系: コードコピー | コード表示 → コピーボタン | クリップボードにコピー（トースト表示） |
| 3 | 正常系: 有効期限表示 | コード生成後 | 「有効期限: 24時間」の表示 |
| 4 | 正常系: 再生成 | 既にコード表示中 → 再度生成ボタン | 新しいコードが表示される |

### 2.2 招待コードで参加

| # | テストケース | 操作手順 | 期待結果 |
|---|------------|---------|---------|
| 1 | 正常系: ペア成立 | UserAがコード生成 → UserBがコード入力 → 「参加する」 | UserBが `/feed` にリダイレクト |
| 2 | 異常系: 無効コード | 存在しないコード入力 → 参加 | エラーメッセージ表示 |
| 3 | 異常系: 自分のコード | 自分が生成したコード入力 → 参加 | エラーメッセージ表示 |
| 4 | 異常系: 空コード | 未入力 → 参加 | バリデーションエラー |

### 2.3 ペア成立後の確認

| # | テストケース | 操作手順 | 期待結果 |
|---|------------|---------|---------|
| 1 | フィード画面にペア相手のアバター表示 | ペア成立後 → `/feed` | AppBarに相手のアバター表示 |
| 2 | 再ログインでもペア維持 | ログアウト → 再ログイン | `/feed` にリダイレクト（ペア維持） |

---

## 3. 写真投稿フロー

### 3.1 写真投稿

| # | テストケース | 操作手順 | 期待結果 |
|---|------------|---------|---------|
| 1 | 正常系: 写真投稿（キャプション付き） | `/post` → 写真選択 → プレビュー確認 → キャプション入力 → 投稿 | `/feed` にリダイレクト、投稿した写真が先頭に表示 |
| 2 | 正常系: 写真投稿（キャプションなし） | `/post` → 写真選択 → キャプション未入力 → 投稿 | 成功、キャプション欄は空 |
| 3 | 正常系: プレビュー表示 | 写真選択後 | 選択画像のプレビューが表示される |
| 4 | 異常系: ファイル未選択で投稿 | `/post` → 投稿ボタン | 投稿ボタンが無効 or エラー |
| 5 | 異常系: 10MB超過ファイル | 大きなファイルを選択 | エラーメッセージ「10MB以下の画像を選んでください」 |
| 6 | 異常系: 非対応形式 | GIFファイル選択 | エラーメッセージ「JPEG/PNG/WebPのみ対応」 |
| 7 | 正常系: キャプション文字数カウンター | キャプション入力中 | `{入力文字数}/200` が更新される |
| 8 | 異常系: 201文字キャプション | 201文字入力 → 投稿 | エラー or 入力制限 |
| 9 | 正常系: キャンセル | `/post` → キャンセルボタン | フィードに戻る |

---

## 4. フィード表示

### 4.1 フィード画面

| # | テストケース | 前提条件 | 期待結果 |
|---|------------|---------|---------|
| 1 | 写真一覧が時系列降順で表示 | 複数写真投稿済み | 新しい順に写真カードが並ぶ |
| 2 | 写真カードの構成要素 | 投稿あり | アバター + ユーザー名 + 写真 + いいね/コメントアイコン + キャプション + 相対時間 |
| 3 | 自分と相手の投稿が混在表示 | 両者が投稿 | 両方の写真が時系列で表示 |
| 4 | 写真タップで詳細画面 | 写真クリック | `/photos/[photoId]` に遷移 |
| 5 | 空フィード | 投稿なし | 「まだ写真がありません」メッセージ |
| 6 | ボトムナビゲーション | フィード画面 | 5タブが表示、フィードタブがアクティブ |

---

## 5. いいねフロー

### 5.1 いいね操作

| # | テストケース | 操作手順 | 期待結果 |
|---|------------|---------|---------|
| 1 | 正常系: いいね追加 | 相手の写真 → ハートアイコンクリック | ハートが赤くなる |
| 2 | 正常系: いいね取り消し | いいね済みの写真 → ハートアイコンクリック | ハートがグレーに戻る |
| 3 | 正常系: ダブルタップでいいね | 相手の写真をダブルクリック | ハートアニメーション + いいね追加 |
| 4 | 自分の写真にいいね不可 | 自分の写真 → ハートアイコン | ボタンが非表示 or 無効 |
| 5 | いいね状態の永続化 | いいね → ページリロード | いいね状態が維持されている |

---

## 6. コメントフロー

### 6.1 コメント操作

| # | テストケース | 操作手順 | 期待結果 |
|---|------------|---------|---------|
| 1 | 正常系: コメント投稿 | 写真詳細 → コメント入力 → 送信 | コメント一覧に追加表示 |
| 2 | 正常系: 自分の写真にもコメント可 | 自分の写真 → コメント投稿 | 成功 |
| 3 | 正常系: コメント編集 | 自分のコメント → 編集操作 → 本文変更 → 保存 | コメントが更新表示される |
| 4 | 正常系: コメント削除 | 自分のコメント → 削除操作 → 確認 | コメントが一覧から消える |
| 5 | 異常系: 空コメント送信 | 未入力 → 送信 | 送信ボタン無効 |
| 6 | 異常系: 200文字超過 | 201文字入力 | 入力制限 or エラー |
| 7 | コメント表示順 | 複数コメント投稿 | 古い順（昇順）で表示 |
| 8 | 相手のコメントは編集・削除不可 | 相手のコメント | 編集・削除ボタンが非表示 |

---

## 7. ベスト選出フロー

### 7.1 ベスト選出

| # | テストケース | 操作手順 | 期待結果 |
|---|------------|---------|---------|
| 1 | 正常系: ベスト選出 | `/best` → 相手の写真一覧 → 写真タップ | チェックマーク表示 + 選出完了メッセージ |
| 2 | 正常系: ベスト変更 | 選出済み → 別の写真タップ | チェックマークが移動 |
| 3 | 正常系: 今月の写真のみ表示 | `/best` | 相手の今月の写真のみグリッド表示 |
| 4 | 正常系: 選出状況の表示 | 選出後 | 「選出中: 〇〇」の表示 |
| 5 | 相手の写真なし | 相手が今月未投稿 | 「まだ写真がありません」メッセージ |
| 6 | 選出状態の永続化 | 選出 → ページリロード | 選出状態が維持されている |

### 7.2 ベスト選出のプライバシー

| # | テストケース | 操作手順 | 期待結果 |
|---|------------|---------|---------|
| 1 | 未確定の選出は相手に見えない | UserAが選出 → UserBが確認 | UserBには未確定の選出が見えない |

---

## 8. アーカイブフロー

### 8.1 アーカイブ閲覧

| # | テストケース | 操作手順 | 期待結果 |
|---|------------|---------|---------|
| 1 | 正常系: 確定済みベスト表示 | `/archive` | 月別にベスト写真が2枚並んで表示 |
| 2 | 正常系: 月送り（前月） | 左矢印クリック | 前月のベストが表示 |
| 3 | 正常系: 月送り（次月） | 右矢印クリック | 次月のベストが表示 |
| 4 | 片方のみ選出 | 片方だけベスト選出した月 | 1枚の写真 + 「ベストなし」 |
| 5 | 両方未選出 | ベストなしの月 | 「ベストなし」× 2 |
| 6 | キャプション表示 | 確定済みベストあり | 写真下にキャプション表示 |
| 7 | 空アーカイブ | 確定済みデータなし | 「まだアーカイブがありません」メッセージ |

---

## 9. プロフィールフロー

### 9.1 プロフィール表示

| # | テストケース | 操作手順 | 期待結果 |
|---|------------|---------|---------|
| 1 | 自分のプロフィール表示 | ボトムナビ → プロフィール | アバター + 表示名 + 投稿数 + 写真グリッド |
| 2 | 相手のプロフィール表示 | フィードの相手のユーザー名タップ | 相手のアバター + 表示名 + 投稿数 + 写真グリッド |
| 3 | 写真グリッド表示 | プロフィール画面 | 投稿写真が3カラムグリッドで表示 |
| 4 | 自分のプロフィールに設定ボタン | 自分のプロフィール | 設定アイコン（⚙️）が表示 |
| 5 | 相手のプロフィールに設定なし | 相手のプロフィール | 設定アイコンなし |

### 9.2 プロフィール編集

| # | テストケース | 操作手順 | 期待結果 |
|---|------------|---------|---------|
| 1 | 正常系: 表示名変更 | 設定 → 表示名変更 → 保存 | 成功メッセージ、プロフィールに反映 |
| 2 | 正常系: アバター変更 | 設定 → アバター変更ボタン → 画像選択 → 保存 | 新しいアバターが表示 |
| 3 | 異常系: 表示名空で保存 | 表示名を空にして保存 | バリデーションエラー |

---

## 10. ペア解除フロー

### 10.1 ペア解除

| # | テストケース | 操作手順 | 期待結果 |
|---|------------|---------|---------|
| 1 | 正常系: ペア解除 | 設定 → 「ペアを解除する」→ 確認ダイアログ →「解除する」 | `/pairing` にリダイレクト |
| 2 | 正常系: 確認ダイアログ表示 | 「ペアを解除する」クリック | 確認ダイアログが表示される |
| 3 | キャンセル | 確認ダイアログ → キャンセル | ダイアログが閉じる、設定画面のまま |
| 4 | ペア解除後の状態 | 解除後 → ペアリング画面 | 新しいコード生成 or コード入力が可能 |
| 5 | ペア解除後のデータ保持 | 解除 → 新ペア成立後 | 旧ペアのデータは表示されない（アクティブペアのみ） |

---

## 11. 画面遷移・認証ガード

### 11.1 未認証時のリダイレクト

| # | テストケース | 操作手順 | 期待結果 |
|---|------------|---------|---------|
| 1 | `/feed` に直接アクセス | 未ログイン → `/feed` | `/` にリダイレクト |
| 2 | `/post` に直接アクセス | 未ログイン → `/post` | `/` にリダイレクト |
| 3 | `/best` に直接アクセス | 未ログイン → `/best` | `/` にリダイレクト |
| 4 | `/archive` に直接アクセス | 未ログイン → `/archive` | `/` にリダイレクト |
| 5 | `/settings` に直接アクセス | 未ログイン → `/settings` | `/` にリダイレクト |
| 6 | `/pairing` に直接アクセス | 未ログイン → `/pairing` | `/` にリダイレクト |

### 11.2 ペアなし時のリダイレクト

| # | テストケース | 操作手順 | 期待結果 |
|---|------------|---------|---------|
| 1 | `/feed` に直接アクセス | ログイン済みペアなし → `/feed` | `/pairing` にリダイレクト |
| 2 | `/post` に直接アクセス | ログイン済みペアなし → `/post` | `/pairing` にリダイレクト |
| 3 | `/best` に直接アクセス | ログイン済みペアなし → `/best` | `/pairing` にリダイレクト |

### 11.3 ボトムナビゲーション遷移

| # | テストケース | 操作手順 | 期待結果 |
|---|------------|---------|---------|
| 1 | フィード → 投稿 | 投稿タブクリック | `/post` に遷移 |
| 2 | フィード → ベスト | ベストタブクリック | `/best` に遷移 |
| 3 | フィード → アーカイブ | アーカイブタブクリック | `/archive` に遷移 |
| 4 | フィード → プロフィール | プロフィールタブクリック | `/profile/[自分のID]` に遷移 |

---

## 12. 統合シナリオ（エンドツーエンド）

### 12.1 完全フロー: 新規ユーザー2人のペアリングから写真投稿まで

```
1. UserA: サインアップ → /pairing に遷移
2. UserA: 招待コード生成 → コード控え
3. UserB: サインアップ → /pairing に遷移
4. UserB: UserAのコード入力 → 参加 → /feed に遷移
5. UserA: /feed に遷移（ペア成立済み）
6. UserA: /post → 写真選択 → キャプション入力 → 投稿
7. UserA: /feed で自分の投稿を確認
8. UserB: /feed でUserAの投稿を確認
9. UserB: UserAの写真にいいね → ハートが赤くなる
10. UserB: UserAの写真にコメント → コメント表示
11. UserA: 写真詳細で UserBのいいね・コメントを確認
```

**検証ポイント**: 各ステップ後にページの表示内容が正しいこと

### 12.2 完全フロー: ベスト選出からアーカイブまで

```
1. UserA: 複数の写真を投稿
2. UserB: 複数の写真を投稿
3. UserA: /best → UserBの写真から1枚選出
4. UserB: /best → UserAの写真から1枚選出
5. （Cron実行をシミュレート: confirm_monthly_bests RPC呼出）
6. UserA: /archive → 確定済みベスト表示を確認
7. UserB: /archive → 確定済みベスト表示を確認
```

**検証ポイント**: 確定前は相手の選出が見えず、確定後に両者のベストが表示されること

### 12.3 完全フロー: ペア解除と再ペアリング

```
1. UserA + UserB: ペア状態でフィードに写真あり
2. UserA: /settings → ペア解除 → 確認 → /pairing に遷移
3. UserB: ページリロード → /pairing に遷移（ペア解除されている）
4. UserA: 新しい招待コード生成
5. UserC: サインアップ → UserAのコード入力 → ペア成立
6. UserA: /feed → 旧ペア（UserB）の写真は表示されない
```

**検証ポイント**: ペア解除後にデータが残っているが、新ペアのデータのみ表示されること

---

## 13. テストファイル構成（想定）

```
e2e/
├── fixtures/
│   ├── auth.ts              # ログイン・サインアップヘルパー
│   ├── pair.ts              # ペアリングヘルパー
│   └── photo.ts             # 写真投稿ヘルパー（テスト画像含む）
├── auth.spec.ts             # 1. 認証フロー
├── pairing.spec.ts          # 2. ペアリングフロー
├── photo-post.spec.ts       # 3. 写真投稿フロー
├── feed.spec.ts             # 4. フィード表示
├── like.spec.ts             # 5. いいねフロー
├── comment.spec.ts          # 6. コメントフロー
├── best.spec.ts             # 7. ベスト選出フロー
├── archive.spec.ts          # 8. アーカイブフロー
├── profile.spec.ts          # 9. プロフィールフロー
├── pair-dissolve.spec.ts    # 10. ペア解除フロー
├── navigation.spec.ts       # 11. 画面遷移・認証ガード
└── scenarios/
    ├── full-flow.spec.ts           # 12.1 完全フロー
    ├── best-archive-flow.spec.ts   # 12.2 ベスト→アーカイブ
    └── dissolve-repair.spec.ts     # 12.3 ペア解除→再ペアリング
```

---

## 14. Playwright設定方針

```ts
// playwright.config.ts の想定設定
{
  testDir: './e2e',
  timeout: 30000,
  use: {
    baseURL: 'http://localhost:3000',
    viewport: { width: 375, height: 812 },  // モバイルファースト
    screenshot: 'only-on-failure',
    trace: 'on-first-retry',
  },
  webServer: {
    command: 'npm run dev',
    port: 3000,
    reuseExistingServer: true,
  },
  projects: [
    { name: 'mobile', use: { viewport: { width: 375, height: 812 } } },
  ],
}
```
