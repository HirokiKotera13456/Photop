# Photop ユニットテスト仕様書

テストフレームワーク: **Vitest** + **React Testing Library**

---

## 1. バリデーション関数

### 1.1 メールアドレスバリデーション (`validateEmail`)

| # | テストケース | 入力 | 期待結果 |
|---|------------|------|---------|
| 1 | 正常なメールアドレス | `"user@example.com"` | `true` |
| 2 | サブドメイン付き | `"user@mail.example.com"` | `true` |
| 3 | `+`タグ付き | `"user+tag@example.com"` | `true` |
| 4 | `@`なし | `"userexample.com"` | `false` |
| 5 | ドメインなし | `"user@"` | `false` |
| 6 | ローカル部なし | `"@example.com"` | `false` |
| 7 | 空文字 | `""` | `false` |
| 8 | スペースを含む | `"user @example.com"` | `false` |
| 9 | 日本語ドメイン | `"user@例え.jp"` | `false` |

### 1.2 パスワード強度バリデーション (`validatePassword`)

| # | テストケース | 入力 | 期待結果 |
|---|------------|------|---------|
| 1 | 6文字以上（正常） | `"abcdef"` | `true` |
| 2 | 英数字混合 | `"abc123"` | `true` |
| 3 | 5文字（不足） | `"abcde"` | `false` |
| 4 | 空文字 | `""` | `false` |
| 5 | 1文字 | `"a"` | `false` |
| 6 | 長いパスワード（100文字） | `"a".repeat(100)` | `true` |
| 7 | 記号を含む | `"p@ss!1"` | `true` |

### 1.3 キャプション文字数バリデーション (`validateCaption`)

| # | テストケース | 入力 | 期待結果 |
|---|------------|------|---------|
| 1 | 空文字（任意なので有効） | `""` | `true` |
| 2 | `null`（任意） | `null` | `true` |
| 3 | 200文字ちょうど | `"あ".repeat(200)` | `true` |
| 4 | 199文字 | `"あ".repeat(199)` | `true` |
| 5 | 201文字（超過） | `"あ".repeat(201)` | `false` |
| 6 | 絵文字を含む（200文字以内） | `"📸".repeat(50)` | `true` |
| 7 | 改行を含む | `"行1\n行2"` | `true` |

### 1.4 招待コード形式バリデーション (`validateInviteCode`)

| # | テストケース | 入力 | 期待結果 |
|---|------------|------|---------|
| 1 | 正常（6桁英数字大文字） | `"ABC123"` | `true` |
| 2 | 小文字（自動変換前提で有効） | `"abc123"` | `true` |
| 3 | 5桁（不足） | `"ABC12"` | `false` |
| 4 | 7桁（超過） | `"ABC1234"` | `false` |
| 5 | 空文字 | `""` | `false` |
| 6 | 記号を含む | `"ABC!23"` | `false` |
| 7 | スペースを含む | `"AB C12"` | `false` |
| 8 | 全て数字 | `"123456"` | `true` |
| 9 | 全て英字 | `"ABCDEF"` | `true` |

### 1.5 コメント本文バリデーション (`validateCommentBody`)

| # | テストケース | 入力 | 期待結果 |
|---|------------|------|---------|
| 1 | 正常なコメント | `"いい写真！"` | `true` |
| 2 | 200文字ちょうど | `"a".repeat(200)` | `true` |
| 3 | 201文字（超過） | `"a".repeat(201)` | `false` |
| 4 | 空文字（不可） | `""` | `false` |
| 5 | スペースのみ | `"   "` | `false` |

---

## 2. ユーティリティ関数

### 2.1 月文字列生成 (`formatMonth`)

| # | テストケース | 入力 | 期待結果 |
|---|------------|------|---------|
| 1 | 通常の日付 | `new Date('2026-02-15')` | `"2026-02"` |
| 2 | 年末 | `new Date('2026-12-31')` | `"2026-12"` |
| 3 | 年始 | `new Date('2026-01-01')` | `"2026-01"` |
| 4 | 引数なし（現在月） | `undefined` | 現在の `YYYY-MM` |

### 2.2 相対時間表示 (`formatRelativeTime`)

| # | テストケース | 入力（現在との差分） | 期待結果 |
|---|------------|------------------|---------|
| 1 | 数秒前 | 30秒前 | `"たった今"` |
| 2 | 数分前 | 5分前 | `"5分前"` |
| 3 | 1時間前 | 60分前 | `"1時間前"` |
| 4 | 数時間前 | 3時間前 | `"3時間前"` |
| 5 | 1日前 | 24時間前 | `"1日前"` |
| 6 | 数日前 | 3日前 | `"3日前"` |
| 7 | 1週間以上前 | 10日前 | `"YYYY/MM/DD"` 形式の日付 |

### 2.3 ファイルサイズチェック (`validateFileSize`)

| # | テストケース | 入力 | 期待結果 |
|---|------------|------|---------|
| 1 | 1MB（正常） | `1 * 1024 * 1024` | `true` |
| 2 | 10MB ちょうど（上限） | `10 * 1024 * 1024` | `true` |
| 3 | 10MB + 1バイト（超過） | `10 * 1024 * 1024 + 1` | `false` |
| 4 | 0バイト | `0` | `false` |
| 5 | 5MB | `5 * 1024 * 1024` | `true` |

### 2.4 MIME type検証 (`validateMimeType`)

| # | テストケース | 入力 | 期待結果 |
|---|------------|------|---------|
| 1 | JPEG | `"image/jpeg"` | `true` |
| 2 | PNG | `"image/png"` | `true` |
| 3 | WebP | `"image/webp"` | `true` |
| 4 | GIF（非対応） | `"image/gif"` | `false` |
| 5 | SVG（非対応） | `"image/svg+xml"` | `false` |
| 6 | PDF（非画像） | `"application/pdf"` | `false` |
| 7 | 空文字 | `""` | `false` |
| 8 | テキスト | `"text/plain"` | `false` |

---

## 3. React Hooks

各フックは Supabase クライアントをモックして `renderHook` でテストする。

### 3.1 `useAuth`

| # | テストケース | セットアップ | 期待結果 |
|---|------------|------------|---------|
| 1 | 初期状態: ローディング | セッション取得中 | `{ user: null, loading: true }` |
| 2 | ログイン済み | セッションあり | `{ user: { id, email }, loading: false }` |
| 3 | 未ログイン | セッションなし | `{ user: null, loading: false }` |
| 4 | `signUp` 成功 | モックで成功返却 | `user` がセットされる |
| 5 | `signUp` 失敗（重複メール） | モックでエラー返却 | `error` がセットされる |
| 6 | `signIn` 成功 | モックで成功返却 | `user` がセットされる |
| 7 | `signIn` 失敗（認証情報不正） | モックでエラー返却 | `error` がセットされる |
| 8 | `signOut` | モックで成功返却 | `user` が `null` に戻る |
| 9 | セッション変更リスナー | `onAuthStateChange` 発火 | 状態が更新される |

### 3.2 `usePair`

| # | テストケース | セットアップ | 期待結果 |
|---|------------|------------|---------|
| 1 | ペアなし | クエリ結果が空 | `{ pair: null, hasPair: false }` |
| 2 | アクティブなペアあり | クエリでペア返却 | `{ pair: {...}, hasPair: true, partner: {...} }` |
| 3 | `generateInviteCode` 成功 | RPC成功 | `inviteCode` がセットされる |
| 4 | `generateInviteCode` 失敗（既にペアあり） | RPCエラー | `error` がセットされる |
| 5 | `joinPair` 成功 | RPC成功 | `pair` がセットされる |
| 6 | `joinPair` 失敗（無効コード） | RPCエラー | `error` がセットされる |
| 7 | `dissolvePair` 成功 | UPDATE成功 | `pair` が `null` に戻る |
| 8 | ペアデータ再取得 | `refetch` 呼出 | 最新データが反映される |

### 3.3 `usePhotos`

| # | テストケース | セットアップ | 期待結果 |
|---|------------|------------|---------|
| 1 | フィード取得（写真あり） | クエリで配列返却 | `photos` に写真一覧 |
| 2 | フィード取得（空） | クエリで空配列 | `photos: []` |
| 3 | 写真投稿成功 | Storage + INSERT 成功 | 新しい写真がリストに追加 |
| 4 | 写真投稿失敗（サイズ超過） | Storageエラー | `error` がセットされる |
| 5 | 写真削除成功 | DELETE成功 | リストから削除される |
| 6 | ページネーション | offset指定で取得 | 次のページの写真が返る |

### 3.4 `useLike`

| # | テストケース | セットアップ | 期待結果 |
|---|------------|------------|---------|
| 1 | いいね状態確認（未いいね） | クエリで `null` | `{ isLiked: false }` |
| 2 | いいね状態確認（いいね済み） | クエリでレコード | `{ isLiked: true }` |
| 3 | いいね追加（トグル） | INSERT成功 | `isLiked` が `true` に |
| 4 | いいね取り消し（トグル） | DELETE成功 | `isLiked` が `false` に |
| 5 | 楽観的更新 | トグル実行 | UI即座に更新、サーバー確認後に確定 |

### 3.5 `useComments`

| # | テストケース | セットアップ | 期待結果 |
|---|------------|------------|---------|
| 1 | コメント一覧取得 | クエリで配列返却 | 時系列昇順で返る |
| 2 | コメント投稿成功 | INSERT成功 | リストに追加される |
| 3 | コメント投稿失敗（空本文） | バリデーションエラー | `error` がセットされる |
| 4 | コメント編集成功 | UPDATE成功 | リスト内の該当コメントが更新 |
| 5 | コメント削除成功 | DELETE成功 | リストから削除される |

### 3.6 `useMonthlyBest`

| # | テストケース | セットアップ | 期待結果 |
|---|------------|------------|---------|
| 1 | 今月の選出状況（未選出） | クエリで `null` | `{ currentBest: null }` |
| 2 | 今月の選出状況（選出済み） | クエリでレコード | `{ currentBest: {...} }` |
| 3 | ベスト選出成功 | RPC成功 | `currentBest` が更新 |
| 4 | ベスト変更成功 | RPC成功 | `currentBest.photo_id` が変更 |
| 5 | 相手の写真一覧取得 | クエリで配列返却 | 相手の今月の写真のみ返る |

### 3.7 `useArchive`

| # | テストケース | セットアップ | 期待結果 |
|---|------------|------------|---------|
| 1 | アーカイブ取得（データあり） | クエリで配列返却 | 確定済みベスト一覧 |
| 2 | アーカイブ取得（空） | クエリで空配列 | 空配列 |
| 3 | 特定月のベスト取得 | month指定クエリ | 最大2件（自分+相手の選出） |
| 4 | 月なしの月 | 該当月データなし | 空配列 |

---

## 4. UIコンポーネント

### 4.1 ボタンコンポーネント

| # | テストケース | 操作 | 期待結果 |
|---|------------|------|---------|
| 1 | 通常状態で表示 | レンダリング | テキストが表示される |
| 2 | `disabled` 時の表示 | `disabled={true}` | クリック不可、スタイルが変わる |
| 3 | ローディング中 | `loading={true}` | スピナー表示、クリック不可 |
| 4 | クリックイベント | ボタンクリック | `onClick` ハンドラが呼ばれる |

### 4.2 ログイン/サインアップフォーム

| # | テストケース | 操作 | 期待結果 |
|---|------------|------|---------|
| 1 | 初期表示 | レンダリング | メール・パスワード欄が空 |
| 2 | メール入力 | テキスト入力 | 値が反映される |
| 3 | 不正メールで送信 | 不正メール入力 → 送信 | バリデーションエラー表示 |
| 4 | パスワード短すぎで送信 | 5文字入力 → 送信 | バリデーションエラー表示 |
| 5 | 正常入力で送信 | 有効な入力 → 送信 | `onSubmit` が正しい値で呼ばれる |
| 6 | サインアップ切替 | 切替リンククリック | 表示名入力欄が追加される |
| 7 | サーバーエラー表示 | エラープロップ渡し | エラーメッセージが表示される |

### 4.3 招待コード入力フォーム

| # | テストケース | 操作 | 期待結果 |
|---|------------|------|---------|
| 1 | 6文字入力可能 | 6桁入力 | 入力値が反映される |
| 2 | 7文字以上入力不可 | 7桁入力 | 6文字で切れる |
| 3 | 英数字以外入力不可 | 記号入力 | フィルタされる |
| 4 | 空で送信 | 未入力 → 送信 | バリデーションエラー |

### 4.4 写真カード（フィード）

| # | テストケース | セットアップ | 期待結果 |
|---|------------|------------|---------|
| 1 | ユーザー名表示 | `user.display_name` | ヘッダーに表示 |
| 2 | アバター表示 | `user.avatar_url` | `Avatar` に画像 |
| 3 | キャプション表示 | `caption` あり | テキスト表示 |
| 4 | キャプションなし | `caption: null` | キャプション非表示 |
| 5 | 相対時間表示 | `created_at` | 「2時間前」等 |
| 6 | いいねアイコン（済み） | `isLiked: true` | 赤いハートアイコン |
| 7 | いいねアイコン（未） | `isLiked: false` | グレーのハートアイコン |
| 8 | コメントアイコン + 件数 | `commentCount: 3` | アイコン + `3` |

### 4.5 いいねトグル

| # | テストケース | 操作 | 期待結果 |
|---|------------|------|---------|
| 1 | 未いいね → いいね | ハートアイコンクリック | `onLike` が呼ばれる |
| 2 | いいね済み → 取り消し | ハートアイコンクリック | `onUnlike` が呼ばれる |
| 3 | ダブルタップでいいね | 写真をダブルクリック | `onLike` が呼ばれる（未いいね時） |
| 4 | ダブルタップ（既にいいね済み） | 写真をダブルクリック | 何も起こらない（取り消しにはならない） |
| 5 | 自分の写真ではいいね不可 | `isOwnPhoto: true` | いいねボタン非表示 or 無効 |

### 4.6 コメントリスト

| # | テストケース | セットアップ | 期待結果 |
|---|------------|------------|---------|
| 1 | コメント一覧表示 | 複数コメント | 時系列昇順で表示 |
| 2 | コメントなし | 空配列 | 空状態メッセージ |
| 3 | 自分のコメントに編集・削除ボタン | 自分の `user_id` | ボタン表示 |
| 4 | 相手のコメントに編集・削除なし | 相手の `user_id` | ボタン非表示 |
| 5 | ユーザー名とアバター | コメントデータ | 各コメントに表示 |

### 4.7 コメント入力フォーム

| # | テストケース | 操作 | 期待結果 |
|---|------------|------|---------|
| 1 | テキスト入力 | 文字入力 | 値が反映される |
| 2 | 200文字制限 | 201文字入力 | 200文字で制限 or エラー表示 |
| 3 | 空文字で送信不可 | 未入力 → 送信 | 送信ボタン無効 |
| 4 | 正常送信 | テキスト入力 → 送信 | `onSubmit` 呼出、入力欄クリア |

### 4.8 写真投稿フォーム

| # | テストケース | 操作 | 期待結果 |
|---|------------|------|---------|
| 1 | ファイル選択 | 画像ファイル選択 | プレビュー表示 |
| 2 | 非対応形式選択 | GIFファイル選択 | エラーメッセージ |
| 3 | サイズ超過 | 11MBファイル選択 | エラーメッセージ |
| 4 | キャプション入力 | テキスト入力 | 文字数カウンター更新 |
| 5 | 200文字超過 | 201文字入力 | エラー表示 |
| 6 | ファイル未選択で投稿 | 投稿ボタンクリック | ボタン無効 or エラー |
| 7 | 正常投稿 | 画像 + キャプション → 投稿 | `onSubmit` 呼出 |

### 4.9 ベスト選出グリッド

| # | テストケース | セットアップ | 期待結果 |
|---|------------|------------|---------|
| 1 | 相手の写真一覧表示 | 写真配列 | 3カラムグリッドで表示 |
| 2 | 写真なし | 空配列 | 「写真がありません」メッセージ |
| 3 | 写真タップで選出 | 写真クリック | `onSelect` が `photoId` で呼ばれる |
| 4 | 選出済みマーク表示 | `selectedPhotoId` 指定 | チェックマーク表示 |
| 5 | 別の写真タップで変更 | 別写真クリック | `onSelect` が新しい `photoId` で呼ばれる |

### 4.10 アーカイブカード

| # | テストケース | セットアップ | 期待結果 |
|---|------------|------------|---------|
| 1 | 月表示 | `month: "2026-01"` | 「2026年1月」と表示 |
| 2 | 両者のベスト表示 | 2件のデータ | 2枚の写真が横並び |
| 3 | 片方のみ選出 | 1件のデータ | 1枚 + 「ベストなし」 |
| 4 | 両方未選出 | 0件 | 「ベストなし」× 2 |
| 5 | キャプション表示 | `caption` あり | 写真下にキャプション |

### 4.11 ボトムナビゲーション

| # | テストケース | 操作 | 期待結果 |
|---|------------|------|---------|
| 1 | 5つのタブ表示 | レンダリング | フィード/投稿/ベスト/アーカイブ/プロフィール |
| 2 | 現在のページがアクティブ | パス `/feed` | フィードタブがハイライト |
| 3 | タブクリックで遷移 | 投稿タブクリック | `/post` へナビゲーション |

### 4.12 プロフィールヘッダー

| # | テストケース | セットアップ | 期待結果 |
|---|------------|------------|---------|
| 1 | アバター・表示名表示 | プロフィールデータ | Avatar + Typography |
| 2 | 投稿数表示 | `photoCount: 42` | 「投稿 42枚」 |
| 3 | 自分のプロフィールに設定ボタン | `isOwnProfile: true` | 設定アイコン表示 |
| 4 | 相手のプロフィールに設定なし | `isOwnProfile: false` | 設定アイコン非表示 |

---

## 5. テストファイル構成（想定）

```
__tests__/
├── utils/
│   ├── validators.test.ts         # 1. バリデーション関数
│   └── formatters.test.ts         # 2. ユーティリティ関数
├── hooks/
│   ├── useAuth.test.ts            # 3.1
│   ├── usePair.test.ts            # 3.2
│   ├── usePhotos.test.ts          # 3.3
│   ├── useLike.test.ts            # 3.4
│   ├── useComments.test.ts        # 3.5
│   ├── useMonthlyBest.test.ts     # 3.6
│   └── useArchive.test.ts         # 3.7
└── components/
    ├── AuthForm.test.tsx           # 4.2
    ├── InviteCodeForm.test.tsx     # 4.3
    ├── PhotoCard.test.tsx          # 4.4
    ├── LikeToggle.test.tsx        # 4.5
    ├── CommentList.test.tsx       # 4.6
    ├── CommentInput.test.tsx      # 4.7
    ├── PostForm.test.tsx          # 4.8
    ├── BestGrid.test.tsx          # 4.9
    ├── ArchiveCard.test.tsx       # 4.10
    ├── BottomNav.test.tsx         # 4.11
    └── ProfileHeader.test.tsx     # 4.12
```

---

## 6. モック戦略

| 対象 | モック方法 |
|------|----------|
| Supabase クライアント | `vi.mock('@supabase/supabase-js')` でモジュールモック |
| `supabase.auth` | 各メソッドを `vi.fn()` でスタブ |
| `supabase.from().select()` 等 | チェーンメソッドをモックオブジェクトで再現 |
| `supabase.storage` | `upload` / `createSignedUrl` / `remove` をスタブ |
| `supabase.rpc` | 引数に応じたレスポンスを返すスタブ |
| Next.js Router | `vi.mock('next/router')` で `useRouter` をモック |
| TanStack Query | `QueryClientProvider` でラップ、または `vi.mock` |
| Date/時間 | `vi.useFakeTimers()` で現在時刻を固定 |
